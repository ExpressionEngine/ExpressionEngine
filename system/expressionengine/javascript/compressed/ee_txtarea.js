/*
 @todo Documentation, reconsider class names
 @todo getSelectedRange is broken in IE

$(textarea).getSelectedText();
$(textarea).getSelectedRange();

selection = $(textarea).createSelection(start, end);
selection.replaceWith('[code]'+selection.getSelectedText()+'[/code]');

$(textarea).insertAtCursor('abc');
$(textarea).scrollToCursor();
*/
(function(){function c(e){this.el=e;this.lastIdx=-2;this.currentIdx=0;if(document.selection){this.range=this.el.createTextRange()}}c.prototype={createSelection:function(g,e){this.el.focus();if("selectionStart" in this.el){this.el.selectionStart=g;this.el.selectionEnd=e}else{if(document.selection){var f=document.selection.createTextRange();f.moveStart("character",-this.el.value.length);f.collapse();f.moveStart("character",g);f.moveEnd("character",e-g);f.select()}}return this},getSelectedText:function(){if("selectionStart" in this.el){return this.el.value.substr(this.el.selectionStart,this.el.selectionEnd-this.el.selectionStart)}else{if(document.selection){this.el.focus();return document.selection.createRange().text}}},getSelectedRange:function(){if("selectionStart" in this.el){return{start:this.el.selectionStart,end:this.el.selectionEnd}}else{if(document.selection){var e=document.selection.createRange(),f=Math.abs(e.duplicate().moveEnd("character",-100000));selectionStart=f-e.text.length;return{start:selectionStart,end:f}}}},replaceWith:function(f){var e;this.el.focus();if("selectionStart" in this.el){e=this.el.selectionStart+f.length;this.el.value=this.el.value.substr(0,this.el.selectionStart)+f+this.el.value.substr(this.el.selectionEnd,this.el.value.length);this.el.setSelectionRange(e,e)}else{if(document.selection){document.selection.createRange().text=f}}return this},selectNext:function(h){if("selectionStart" in this.el){var e=this.currentIdx,f;if(e>0){chunk=this.el.value.substring(this.currentIdx)}else{chunk=this.el.value}this.currentIdx=chunk.indexOf(h);if(this.currentIdx!=-1){this.createSelection(e+this.currentIdx,e+this.currentIdx+h.length);this.lastIdx=e+this.currentIdx;this.currentIdx+=e+h.length}else{if(this.lastIdx!=this.currentIdx){this.lastIdx=-1;this.currentIdx=0;this.selectNext(h)}}}else{if(document.selection){this.el.focus();var g=this.range.findText(h,1,0);if(g){this.range.select();this.range.collapse(false)}else{this.range=this.el.createTextRange()}}}},resetCycle:function(){this.lastIdx=-2;this.currentIdx=0;if(document.selection){this.range=this.el.createTextRange()}}};if(jQuery){function a(h){c.call(this,h);var e=13,i=$(this.el),g=i.scrollTop(9999).scrollTop(),f=i.val();i.val(f+"\n");new_height=i.scrollTop(9999).scrollTop();i.val(f).scrollTop(0);this.textarea_line_height=new_height-g;this.jQ_el=i}var b=function(){};b.prototype=c.prototype;a.prototype=new b();a.prototype.constructor=a;a.prototype.scrollToCursor=function(){if("selectionStart" in this.el){var g=this.getSelectedRange(),f=this.jQ_el.val().substr(0,g.start).split("\n"),e=f.length;for(var h=0;h<f.length;h++){length_ratio=f[h].length/this.el.cols;if(length_ratio>1){e+=Math.ceil(length_ratio)}}e=(e>5)?e-5:0;this.jQ_el.scrollTop((e-5)*this.textarea_line_height)}return this}}else{a=c}function d(e){this.el=e;this.sel=new a(this.el)}d.prototype={getSelectionObj:function(){return this.sel},createSelection:function(f,e){return this.sel.createSelection(f,e)},getSelectedText:function(){return this.sel.getSelectedText()},getSelectedRange:function(){return this.sel.getSelectedRange()},insertAtCursor:function(e){this.sel.replaceWith(e)},selectNext:function(e){this.sel.selectNext(e);return this.sel},_resize:function(){var e=this.sel.getSelectedRange();if(e.start==e.end&&e.end==this.el.value.length){this.el.value+="\n";this.sel.createSelection(e.end,e.end)}if(this.el.scrollHeight>this.el.clientHeight){$(this.el).height(this.el.scrollHeight+10)}},autoResize:function(){alert("hi");var f=this,e=$(this.el);e.css("overflow","hidden");e.keypress(function(){f._resize()});e.keyup(function(g){(g.keyCode==13&&f._resize())})}};if(jQuery){for(func in d.prototype){jQuery.fn[func]=(function(e){return function(){var f=Array.prototype.slice.call(arguments),g=this.data("txtarea");if(!g){g=new d(this[0]);this.data("txtarea",g)}return g[e].apply(g,f)}})(func)}}window.Txtarea=d})();