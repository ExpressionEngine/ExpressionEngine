RedactorX.add("plugin","imageresize",{translations:{en:{imageresize:{"image-resize":"Image resize"}}},defaults:{minHeight:20,minWidth:100,zIndex:97},subscribe:{"editor.blur, editor.select":function(){this.stop()},"image.position":function(){this._setResizerPosition()},"editor.unparse, editor.before.cut, editor.before.copy":function(e){this._unparse(e)},"block.set":function(e){this._load()}},stop:function(){this._remove(),this._stopEvents()},_load:function(){var e=this.app.block.get();this._remove(),e.isType("image")&&this._build(e)},_build:function(e){this.$block=e.getBlock(),this.$image=e.getImage(),this.$resizer=this.dom("<span>"),this.$resizer.attr("id",this.prefix+"-image-resizer"),this.$resizer.css({position:"absolute","z-index":this.opts.imageresize.zIndex,"background-color":"#007dff",width:"15px",height:"15px","border-radius":"8px","font-size":"0",border:"2px solid #fff",cursor:"ew-resize"}),this.$image.after(this.$resizer),this._setResizerPosition(),setTimeout(this._setResizerPosition.bind(this),30),this.$resizer.on("mousedown touchstart",this._press.bind(this))},_setResizerPosition:function(){var e=this.$image.position(),i=this.$image.width(),t=this.$image.height(),s=this.$resizer.width(),r=this.$resizer.height();this.$resizer.css({top:Math.round(e.top+t/2-r+9)+"px",left:Math.round(e.left+i-s+9)+"px"})},_press:function(e){e.preventDefault();var i=this.$image.height(),t=this.$image.width();this.resizeHandle={x:e.pageX,y:e.pageY,el:this.$image,$figure:this.$image.closest("figure"),ratio:t/i,h:i,w:t},this.app.event.pause(),this.app.$doc.on("mousemove."+this.prefix+".image-resize touchmove."+this.prefix+".image-resize",this._move.bind(this)),this.app.$doc.on("mouseup."+this.prefix+".image-resize touchend."+this.prefix+".image-resize",this._release.bind(this)),this.app.broadcast("image.resize.start",{e:e,block:this.$block,image:this.$image})},_move:function(e){e.preventDefault();var i=(r=this._getWidth(e))/this.resizeHandle.ratio,t=this.resizeHandle.el,s=this.opts.imageresize,i=Math.round(i),r=Math.round(r);i<s.minHeight||r<s.minWidth||this._getResizableBoxWidth()<=r||(0!==this.resizeHandle.$figure.length&&""!==this.resizeHandle.$figure.css("max-width")&&this.resizeHandle.$figure.css("max-width",r+"px"),t.attr({width:r,height:i}),this._setResizerPosition(),this.app.broadcast("image.resize.move",{e:e,block:this.$block,image:this.$image}))},_release:function(e){this._stopEvents(),this.app.event.run(),this.app.broadcast("image.resize.stop",{e:e,block:this.$block,image:this.$image})},_stopEvents:function(){this.app.$doc.off("."+this.prefix+".image-resize")},_remove:function(){this.app.editor.getLayout().find("#"+this.prefix+"-image-resizer").remove()},_getWidth:function(e){var i=this.resizeHandle.w;return e.targetTouches?i+=e.targetTouches[0].pageX-this.resizeHandle.x:i+=e.pageX-this.resizeHandle.x,i},_getResizableBoxWidth:function(){var e=this.app.editor.getLayout();return e.width()-parseInt(e.css("padding-left"))-parseInt(e.css("padding-right"))},_unparse:function(e){var i=e.get("html"),i=this.app.utils.wrap(i,function(e){e.find("#"+this.prefix+"-image-resizer").remove()}.bind(this));e.set("html",i)}});