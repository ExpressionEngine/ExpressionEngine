RedactorX.add("plugin","handle",{translations:{en:{handle:{handle:"Handle"}}},defaults:{url:!1,start:1,trigger:"@"},subscribe:{"editor.keydown":function(t){this._listen(t)},"editor.keyup":function(t){!1!==this.opts.handle.url&&this._handle(t)}},start:function(){this.handleLen=this.opts.handle.start},stop:function(){this._hide()},_handle:function(t){var t=t.get("e"),e=t.which,t=t.ctrlKey||t.metaKey,i=this.app.keycodes;e===i.ESC?this.app.selection.restore():e===i.DELETE||e===i.SPACE||e===i.SHIFT||t||-1!==[37,38,39,40].indexOf(e)||(e===i.BACKSPACE&&(this.handleLen=this.handleLen-2,this.handleLen<=this.opts.handle.start)&&this._hide(),this._emit())},_listen:function(t){var e,i=t.get("e"),s=i.which,n=this.app.keycodes;if(this._isShown()&&s===n.ENTER)return 0===(e=this._getActiveItem()).length?void this._hideForce():(i.preventDefault(),t.stop(),void this._replace(i,e));!this._isShown()||40!==s&&38!==s||(i.preventDefault(),t.stop(),0===(e=this._getActiveItem()).length?(n=this._getFirstItem(),this._setActive(n)):40===s?this._setNextActive(e):38===s&&this._setPrevActive(e))},_getItems:function(){return this.$panel.find("."+this.prefix+"-panel-item")},_getActiveItem:function(){return this._getItems().filter(function(t){return t.hasClass("active")})},_getFirstItem:function(){return this._getItems().first()},_getLastItem:function(){return this._getItems().last()},_setActive:function(t){this._getItems().removeClass("active"),t.addClass("active");var e=t.outerHeight(),t=t.position().top,i=this.$panel.scrollTop(),s=t+2*e,n=this.$panel.outerHeight();this.$panel.scrollTop(i+n<s?s-n:t-e<i?t-e:i)},_setNextActive:function(t){var t=t.next();0!==t.length?this._setActive(t):(t=this._getFirstItem(),this._setActive(t))},_setPrevActive:function(t){var t=t.prev();0!==t.length?this._setActive(t):(t=this._getLastItem(),this._setActive(t))},_emit:function(){var t=new RegExp("^"+this.opts.handle.trigger);this.handleStr=this.app.selection.getText("before",this.handleLen),this.handleStr2=this.app.selection.getText("before",this.handleLen+1),t.test(this.handleStr)&&(this.handleStr2&&" "===this.handleStr2[0]||""===this.handleStr2[0])&&(this.handleStr=this.handleStr.replace(this.opts.handle.trigger,""),this.handleLen++,this.handleLen-1>this.opts.handle.start)&&this._load()},_isShown:function(){return this.$panel&&this.$panel.hasClass("open")},_load:function(){this.ajax.post({url:this.opts.handle.url,data:"handle="+this.handleStr,success:this._parse.bind(this)})},_parse:function(t){""===t||Array.isArray(t)&&0===t.length?this.$panel&&this.$panel.remove():(t="object"==typeof t?t:JSON.parse(t),this._build(t))},_build:function(t){for(var e in this.data=t,this.$panel=this.app.$body.find("."+this.prefix+"-panel"),0===this.$panel.length?(this.$panel=this.dom("<div>").addClass(this.prefix+"-panel"),this.app.$body.append(this.$panel)):this.$panel.html(""),this._stopEvents(),this._startEvents(),t){var i=this.dom("<div>").addClass(this.prefix+"-panel-item"),s=this.dom("<a>").attr("href","#");s.html(t[e].item),s.attr("data-key",e),s.on("click",this._replace.bind(this)),i.append(s),this.$panel.append(i)}var n=this.app.$doc.scrollTop(),h=this.app.selection.getPosition();this.$panel.addClass("open"),this.$panel.css({top:h.bottom+n+"px",left:h.left+"px"}),this.app.selection.save()},_replace:function(t,e){t.preventDefault(),t.stopPropagation();var i,s,n,e=(e?e.find("a"):this.dom(t.target)).attr("data-key"),t=this.data[e].replacement,e=(this.app.marker.insert("start"),this.app.marker.find("start"));!1!==e&&(i=this.dom(e),n=(e=e.previousSibling).textContent,s=new RegExp(this.opts.handle.trigger+this.handleStr+"$"),n=n.replace(s,""),e.textContent=n,i.before(t),this.app.selection.restoreMarker(),this._hide())},_reset:function(){this.handleStr=!1,this.handleLen=this.opts.handle.start,this.$panel=!1},_hide:function(t){var e=!1,i=t&&t.which,s=this.app.keycodes;(e=t&&"click"!==t.type&&i!==s.ESC&&i!==s.SPACE?e:!0)&&this._hideForce()},_hideForce:function(){this.$panel&&this.$panel.remove(),this._reset(),this._stopEvents()},_startEvents:function(){var t="click."+this.prefix+"-plugin-handle keydown."+this.prefix+"-plugin-handle";this.app.$doc.on(t,this._hide.bind(this)),this.app.editor.getEditor().on(t,this._hide.bind(this))},_stopEvents:function(){var t="."+this.prefix+"-plugin-handle";this.app.$doc.off(t),this.app.editor.getEditor().off(t)}});